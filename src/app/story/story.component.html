<mat-card class="container">
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>Vælg en hovedkategori</mat-label>
    <mat-select [(ngModel)]="mainCategory" (selectionChange)="updateSubcategories()">
      <mat-option value="sport">Sport</mat-option>
      <mat-option value="music">Musik</mat-option>
      <mat-option value="science">Videnskab</mat-option>
      <mat-option value="history">Historie</mat-option>
      <mat-option value="film">Film & TV</mat-option>
      <mat-option value="nature">Natur & Miljø</mat-option>
      <mat-option value="space">Rummet</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field appearance="outline" class="full-width" *ngIf="mainCategory">
    <mat-label>Vælg en underkategori</mat-label>
    <mat-select [(ngModel)]="subCategory">
      <mat-option *ngFor="let sub of subcategories" [value]="sub">{{ sub }}</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field appearance="outline" class="full-width" *ngIf="subCategory">
    <mat-label>Indtast specifikt emne</mat-label>
    <input matInput [(ngModel)]="inputTopic" placeholder="Fx Einstein, The Beatles, eller Romerriget">
  </mat-form-field>

  <mat-form-field appearance="outline" class="full-width">
    <mat-label>Vælg Klassetrin</mat-label>
    <mat-select [(ngModel)]="selectedGrade">
      <mat-option *ngFor="let grade of gradeLevels" [value]="grade">Klasse {{ grade }}</mat-option>
    </mat-select>
  </mat-form-field>

  <button mat-raised-button color="primary" (click)="generateStory()"
    [disabled]="loading || !inputTopic || !selectedGrade">
    Generér Historie
  </button>

  <mat-progress-spinner *ngIf="loading" mode="indeterminate"></mat-progress-spinner>

  <mat-card *ngIf="story.length > 0" class="story-box">
    <h2>Genereret Historie:</h2>
    <div *ngFor="let chapter of story; let i = index" class="chapter-container">
      <div class="chapter-texts-container">
        <h3>{{chapter.title}}</h3>
        <div class="chapter-content">
          <div class="chapter-texts">
            <p *ngFor="let paragraph of chapter.texts; let j = index" class="chapter-paragraph">{{ paragraph }}</p>
          </div>
          <div class="chapter-images" *ngIf="chapter.images?.length">
            <div class="image-row" *ngFor="let imgChunk of groupImages(chapter.images, 2)">
              <img *ngFor="let img of imgChunk" [src]="img" class="chapter-image">
            </div>
          </div>
        </div>
      </div>
    </div>
  </mat-card>

  <mat-card *ngIf="story.length > 0" class="story-actions">
    <button mat-raised-button color="accent" (click)="exportToPDF()">Eksporter til PDF</button>
    <button mat-raised-button color="accent" (click)="saveStory()">Gem Historie</button>

    <mat-card *ngIf="previousQuizResult">
      <h3>Tidligere Quizresultat</h3>
      <p>Du fik {{ previousQuizResult.score }} / {{ previousQuizResult.totalQuestions }} rigtige!</p>
    </mat-card>

    <button mat-raised-button color="primary" (click)="startQuiz()">Tag Quiz</button>
  </mat-card>

  <app-quiz *ngIf="quizAvailable" [quiz]="quizData" (quizCompleted)="onQuizCompleted($event)"></app-quiz>
</mat-card>

<style>
  .chapter-container {
    display: flex;
    flex-direction: column;
    margin-bottom: 1.5rem;
  }

  .chapter-texts-container {
    display: flex;
    flex-direction: column;
  }

  .chapter-content {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
  }

  .chapter-texts {
    flex: 1;
  }

  .chapter-paragraph {
    margin-bottom: 1rem;
  }

  .chapter-images {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
    width: 40%;
  }

  .image-row {
    display: flex;
    justify-content: space-between;
    width: 100%;
  }

  .chapter-image {
    width: 48%;
    height: auto;
    max-height: 200px;
    object-fit: contain;
    border-radius: 8px;
    margin-bottom: 0.5rem;
  }
</style>
